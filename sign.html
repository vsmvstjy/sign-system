<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전자 서명</title>
  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;}
    canvas{border:1px solid #ccc;display:block;margin:10px auto;}
    input,button{margin:10px auto;padding:10px;width:90%;max-width:400px;}
  </style>
</head>
<body>
  <h2>전자 서명</h2>
  <p id="docTitle"></p>
  <canvas id="pdfCanvas"></canvas>
  <input type="text" id="userName" placeholder="서명자 이름"><br>
  <canvas id="signaturePad" width="400" height="200" style="width:400px;height:200px;"></canvas><br>
  <button onclick="clearSig()">서명 지우기</button>
  <button onclick="startAuth()">Google 로그인 및 제출</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    let data, pdfDoc, currentPage=1;
    const canvas=document.getElementById('pdfCanvas'), ctx=canvas.getContext('2d');
    window.clearSig=()=>document.getElementById('signaturePad').getContext('2d').clearRect(0,0,400,200);
    window.startAuth=()=>google.accounts.oauth2.initTokenClient({
      client_id:'972595541590-k962h1slhqu6cm1r5fhp9nvdd8hu21vk.apps.googleusercontent.com',
      scope:'https://www.googleapis.com/auth/gmail.send',
      callback:tok=>sendEmail(tok.access_token)
    }).requestAccessToken();
    async function init(){
      const id=new URLSearchParams(location.search).get('id');
      data=JSON.parse(localStorage.getItem('signpos:'+id));
      if(!data){document.body.innerHTML='<h3>잘못된 링크입니다.</h3>';return;}
      document.getElementById('docTitle').innerText=data.docTitle;
      const raw=Uint8Array.from(atob(data.pdfBase64),c=>c.charCodeAt(0));
      pdfDoc=await pdfjsLib.getDocument({data:raw}).promise;
      const page=await pdfDoc.getPage(data.page);
      const vp=page.getViewport({scale:1.2});
      canvas.width=vp.width;canvas.height=vp.height;
      await page.render({canvasContext:ctx,viewport:vp}).promise;
    }
    async function sendEmail(token){
      const name=document.getElementById('userName').value;
      if(!name)return alert('이름을 입력하세요.');
      const raw=Uint8Array.from(atob(data.pdfBase64),c=>c.charCodeAt(0));
      const pdfDocLib=await PDFLib.PDFDocument.load(raw);
      const pages=pdfDocLib.getPages(), page=pages[data.page-1];
      const pngBytes=Uint8Array.from(atob(document.getElementById('signaturePad').toDataURL('image/png').split(',')[1]),c=>c.charCodeAt(0));
      const pngImg=await pdfDocLib.embedPng(pngBytes);
      const {width,height}=pngImg.scale(0.5);
      page.drawImage(pngImg,{x:data.posX,y:page.getHeight()-data.posY-height,width,height});
      const signed=await pdfDocLib.save();
      const signedBase64=btoa(String.fromCharCode(...signed));
      const subject='=?UTF-8?B?'+btoa(unescape(encodeURIComponent('[전자서명 제출] '+data.docTitle+' - '+name)))+'?=';
      const bodyText='본인은 첨부된 "'+data.docTitle+'" 문서를 열람하였고, 이에 동의하여 아래와 같이 서명합니다.\n\n- 제출자 이름: '+name+'\n- 제출 일시: '+new Date().toLocaleString();
      const boundary='BOUNDARY', lines=[
        'MIME-Version: 1.0','Content-Type: multipart/mixed; boundary="'+boundary+'"',
        'To: '+data.receiver,'Subject: '+subject,'','--'+boundary,
        'Content-Type: text/plain; charset=UTF-8','',''+bodyText,'',
        '--'+boundary,'Content-Type: application/pdf','Content-Disposition: attachment; filename="signed.pdf"','Content-Transfer-Encoding: base64','',''+signedBase64,'','--'+boundary+'--'
      ];
      const emailBody=lines.join('\r\n');
      gapi.load('client',()=>gapi.client.init({apiKey:'AIzaSyBdO8g3lJHfxoiSqgOWXp1q37zMkrkaBg4',discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']})
        .then(()=>{gapi.client.setToken({access_token:token});return gapi.client.gmail.users.messages.send({userId:'me',resource:{raw:btoa(unescape(encodeURIComponent(emailBody))).replace(/\+/g,'-').replace(/\//g,'_')}});})
        .then(()=>alert('제출 완료')).catch(e=>{console.error(e);alert('전송 실패');}));
    }
    init();
  </script>
</body>
</html>
