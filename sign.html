<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전자 서명</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
    #pdfContainer { position: relative; width: 100vw; height: 100vh; }
    #pdfCanvas { display: block; width: 100%; height: 100%; }
    #marker { position: absolute; width: 20px; height: 20px; border: 2px dashed red; border-radius: 50%; pointer-events: none; }
    /* Modal */
    .modal { display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; text-align: center; }
    #sigCanvas { border:1px solid #ccc; touch-action: none; }
    button { margin: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <div id="pdfContainer">
    <canvas id="pdfCanvas"></canvas>
    <div id="marker"></div>
  </div>

  <!-- Signature Modal -->
  <div id="sigModal" class="modal">
    <div class="modal-content">
      <h3>서명해 주세요</h3>
      <canvas id="sigCanvas" width="400" height="200"></canvas><br>
      <button id="clearSig">지우기</button>
      <button id="saveSig">완료</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    let data, pdfDoc, viewport;
    const container = document.getElementById('pdfContainer');
    const pdfCanvas = document.getElementById('pdfCanvas');
    const pdfCtx = pdfCanvas.getContext('2d');
    const marker = document.getElementById('marker');
    const sigModal = document.getElementById('sigModal');
    const sigCanvas = document.getElementById('sigCanvas');
    const sigCtx = sigCanvas.getContext('2d');
    let drawing=false;

    async function init() {
      // Load Firestore data
      const snap = await getDoc(doc(db, 'signRequests', id));
      if (!snap.exists()) { alert('잘못된 링크'); return; }
      data = snap.data();

      // Render PDF full page
      const raw = Uint8Array.from(atob(data.pdfBase64), c=>c.charCodeAt(0));
      pdfDoc = await pdfjsLib.getDocument({data:raw}).promise;
      const page = await pdfDoc.getPage(data.page);
      viewport = page.getViewport({scale: window.innerWidth/page.getViewport({scale:1}).width});
      pdfCanvas.width = viewport.width;
      pdfCanvas.height = viewport.height;
      await page.render({canvasContext:pdfCtx,viewport}).promise;

      // Position marker at designated spot
      marker.style.left = (data.posX/ (page.getViewport({scale:1}).width) * viewport.width -10) + 'px';
      marker.style.top = ((viewport.height) - data.posY/ (page.getViewport({scale:1}).height) * viewport.height -10) + 'px';

      // Click listener for magnet snap
      pdfCanvas.addEventListener('click', e=>{
        const rect = pdfCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        // compute marker center
        const mx = parseFloat(marker.style.left) +10;
        const my = parseFloat(marker.style.top) +10;
        if (Math.hypot(x-mx,y-my) < 50) { openModal(); }
      });

      // Signature pad events
      sigCanvas.addEventListener('mousedown', e=>{ drawing=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY); });
      sigCanvas.addEventListener('mousemove', e=>{ if(drawing){ sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke(); } });
      sigCanvas.addEventListener('mouseup', ()=>drawing=false);
      sigCanvas.addEventListener('mouseout', ()=>drawing=false);
      // Touch
      sigCanvas.addEventListener('touchstart', e=>{ e.preventDefault(); drawing=true; const t=e.touches[0]; const r=sigCanvas.getBoundingClientRect(); sigCtx.beginPath(); sigCtx.moveTo(t.clientX-r.left, t.clientY-r.top); });
      sigCanvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(drawing){ const t=e.touches[0]; const r=sigCanvas.getBoundingClientRect(); sigCtx.lineTo(t.clientX-r.left, t.clientY-r.top); sigCtx.stroke(); } });
      sigCanvas.addEventListener('touchend', e=>{ e.preventDefault(); drawing=false; });

      document.getElementById('clearSig').onclick = ()=>sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
      document.getElementById('saveSig').onclick = ()=>{ sigModal.style.display='none'; };
    }

    function openModal(){ sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); sigModal.style.display='flex'; }

    // Firebase & Gmail imports
  </script>
</body>
</html>