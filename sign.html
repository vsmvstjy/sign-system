
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전자 서명</title>
</head>
<body>
  <canvas id="pdfCanvas"></canvas>
  <div id="marker" style="position:absolute; width:100px; height:40px; background:#fff8dc;
    border:2px dashed #ff5c5c; border-radius:6px; text-align:center;
    line-height:40px; font-weight:bold; color:#ff5c5c; font-size:16px;
    box-shadow:0 2px 6px rgba(0,0,0,0.2); display:none;">서명</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDrkWBu5k-2nBHhZEHwgrBrPkWSKpro6po",
      authDomain: "sign-system-a8921.firebaseapp.com",
      projectId: "sign-system-a8921",
      storageBucket: "sign-system-a8921.appspot.com",
      messagingSenderId: "356422555230",
      appId: "1:356422555230:web:5522aefcfc133d096286cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');
    const marker = document.getElementById('marker');

    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    async function init() {
      const snap = await getDoc(doc(db, 'signRequests', id));
      if (!snap.exists()) return alert("유효하지 않은 링크입니다");
      const data = snap.data();
      const raw = Uint8Array.from(atob(data.pdfBase64), c => c.charCodeAt(0));
      const pdf = await pdfjsLib.getDocument({ data: raw }).promise;
      const page = await pdf.getPage(data.page);
      const vp = page.getViewport({ scale: 1.5 });
      canvas.width = vp.width;
      canvas.height = vp.height;
      await page.render({ canvasContext: ctx, viewport: vp }).promise;
      const mx = canvas.width * data.posXPct / 100;
      const my = canvas.height * data.posYPct / 100;
      marker.style.left = `${mx - 50}px`;
      marker.style.top = `${my - 20}px`;
      marker.style.display = 'block';
    }

    init();
  </script>
</body>
</html>
