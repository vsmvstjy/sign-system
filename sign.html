<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전자 서명</title>
  <style>
    body { font-family: sans-serif; text-align:center; padding:20px; }
    canvas { border:1px solid #ccc; display:block; margin:10px auto; }
    #signaturePad { touch-action: none; }
    input,button { margin:10px auto; padding:10px; width:90%; max-width:400px; }
  </style>
</head>
<body>
  <h2>전자 서명</h2>
  <p id="docTitle"></p>
  <canvas id="pdfCanvas"></canvas>
  <input type="text" id="userName" placeholder="서명자 이름"><br>
  <canvas id="signaturePad" width="400" height="200"></canvas><br>
  <button onclick="clearSig()">서명 지우기</button>
  <button onclick="startAuth()">Google 로그인 및 제출</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDrkWBu5k-2nBHhZEHwgrBrPkWSKpro6po",
      authDomain: "sign-system-a8921.firebaseapp.com",
      projectId: "sign-system-a8921",
      storageBucket: "sign-system-a8921.appspot.com",
      messagingSenderId: "356422555230",
      appId: "1:356422555230:web:5522aefcfc133d096286cf",
      measurementId: "G-KD90T9QP1W"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let data, pdfDoc;
    const pdfCanvas = document.getElementById('pdfCanvas'),
          pdfCtx = pdfCanvas.getContext('2d'),
          sigCanvas = document.getElementById('signaturePad'),
          sigCtx = sigCanvas.getContext('2d');

    function clearSig() {
      sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    }

    window.startAuth = () => google.accounts.oauth2.initTokenClient({
      client_id: '972595541590-k962h1slhqu6cm1r5fhp9nvdd8hu21vk.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/gmail.send',
      callback: tok => sendEmail(tok.access_token)
    }).requestAccessToken();

    async function init() {
      const id = new URLSearchParams(location.search).get('id');
      const snap = await getDoc(doc(db, 'signRequests', id));
      if (!snap.exists()) {
        document.body.innerHTML = '<h3>잘못된 링크입니다.</h3>';
        return;
      }
      data = snap.data();
      document.getElementById('docTitle').innerText = data.docTitle;

      const raw = Uint8Array.from(atob(data.pdfBase64), c => c.charCodeAt(0));
      pdfDoc = await pdfjsLib.getDocument({ data: raw }).promise;
      const page = await pdfDoc.getPage(data.page);
      const vp = page.getViewport({ scale: 1.2 });
      pdfCanvas.width = vp.width;
      pdfCanvas.height = vp.height;
      await page.render({ canvasContext: pdfCtx, viewport: vp }).promise;

      let drawing = false;
      // Mouse events
      sigCanvas.onmousedown = e => { drawing = true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX, e.offsetY); };
      sigCanvas.onmousemove = e => { if (drawing) { sigCtx.lineTo(e.offsetX, e.offsetY); sigCtx.stroke(); } };
      sigCanvas.onmouseup = () => drawing = false;
      sigCanvas.onmouseout = () => drawing = false;
      // Touch events
      sigCanvas.addEventListener('touchstart', e => {
        e.preventDefault();
        drawing = true;
        const rect = sigCanvas.getBoundingClientRect();
        const t = e.touches[0];
        sigCtx.beginPath();
        sigCtx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
      });
      sigCanvas.addEventListener('touchmove', e => {
        e.preventDefault();
        if (!drawing) return;
        const rect = sigCanvas.getBoundingClientRect();
        const t = e.touches[0];
        sigCtx.lineTo(t.clientX - rect.left, t.clientY - rect.top);
        sigCtx.stroke();
      });
      sigCanvas.addEventListener('touchend', e => { e.preventDefault(); drawing = false; });
    }

    async function sendEmail(token) {
      const name = document.getElementById('userName').value;
      if (!name) { alert('이름을 입력해주세요.'); return; }

      const raw = Uint8Array.from(atob(data.pdfBase64), c => c.charCodeAt(0));
      const pdfDocLib = await PDFLib.PDFDocument.load(raw);
      const pngDataUrl = sigCanvas.toDataURL('image/png');
      const pngBytes = Uint8Array.from(atob(pngDataUrl.split(',')[1]), c => c.charCodeAt(0));
      const pngImg = await pdfDocLib.embedPng(pngBytes);
      const { width, height } = pngImg.scale(0.3);

      const cmToPx = cm => cm * 37.8;
      const offsetX = cmToPx(2), offsetY = cmToPx(3);
      const drawX = data.posX - offsetX, drawY = data.posY - offsetY;

      const page = pdfDocLib.getPages()[data.page - 1];
      page.drawImage(pngImg, {
        x: drawX,
        y: page.getHeight() - drawY - height,
        width, height
      });

      const signedBytes = await pdfDocLib.save();
      const signedBase64 = btoa(String.fromCharCode(...signedBytes));

      const subject = '=?UTF-8?B?' + btoa(unescape(encodeURIComponent('[전자서명 제출] ' + data.docTitle + ' - ' + name))) + '?=';
      const bodyText = `본인은 첨부된 "${data.docTitle}" 문서를 열람하였고, 이에 동의하여 아래와 같이 서명합니다.

- 제출자 이름: ${name}
- 제출 일시: ${new Date().toLocaleString()}`;

      const boundary = 'BOUNDARY';
      const lines = [
        'MIME-Version: 1.0',
        `To: ${data.receiver}`,
        `Subject: ${subject}`,
        'Content-Type: multipart/mixed; boundary=' + boundary,
        '', '--' + boundary,
        'Content-Type: text/plain; charset=UTF-8', '', bodyText, '',
        '--' + boundary,
        'Content-Type: application/pdf',
        'Content-Disposition: attachment; filename="signed.pdf"',
        'Content-Transfer-Encoding: base64', '', signedBase64, '--' + boundary + '--'
      ];
      const emailBody = lines.join('\r\n');

      gapi.load('client', () => {
        gapi.client.init({
          apiKey: 'AIzaSyBdO8g3lJHfxoiSqgOWXp1q37zMkrkaBg4',
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
        }).then(() => {
          gapi.client.setToken({ access_token: token });
          return gapi.client.gmail.users.messages.send({
            userId: 'me',
            resource: { raw: btoa(unescape(encodeURIComponent(emailBody))).replace(/\+/g, '-').replace(/\//g, '_') }
          });
        }).then(() => alert('제출 완료!')).catch(e => { console.error(e); alert('전송 실패'); });
      });
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
