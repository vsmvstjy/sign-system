<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전자 서명</title>
  <style>
    body { margin: 0; padding: 20px; font-family: sans-serif; background: #f9f9f9; }
    #pdfContainer { position: relative; width: 100%; max-width: 800px; margin: 0 auto; }
    canvas { display: block; width: 100%; height: auto; background: white; }
    #marker {
      position: absolute; width: 100px; height: 40px;
      background: rgba(255, 248, 220, 0.5);
      border: 2px dashed #ff5c5c;
      border-radius: 6px; display: none;
      text-align: center; line-height: 40px; font-weight: bold; color: #ff5c5c;
      pointer-events: none;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: #1890ff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #40a9ff;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    #nameInput {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div style="text-align:center; margin-bottom:10px;">
  <button id="prevPage">이전 페이지</button>
  <span id="pageInfo">0 / 0</span>
  <button id="nextPage">다음 페이지</button>
</div>

<div id="pdfContainer">
  <canvas id="pdfCanvas"></canvas>
  <div id="marker">서명</div>
</div>

<!-- 이름 입력 모달 -->
<div id="nameModal" class="modal">
  <div class="modal-content">
    <h3>이름을 입력하세요</h3>
    <input type="text" id="nameInput" placeholder="이름 입력">
    <button id="nameConfirm">확인</button>
  </div>
</div>

<!-- 서명 모달 -->
<div id="sigModal" class="modal">
  <div class="modal-content">
    <h3 style="font-size:40px;">서명해 주세요</h3>
    <canvas id="sigCanvas" width="800" height="300"></canvas><br>
    <button id="clearSig" style="padding: 20px 40px; font-size: 30px;">지우기</button>
    <button id="saveSig" style="padding: 20px 40px; font-size: 30px;">완료</button>
  </div>
</div>

<!-- 제출 완료 모달 -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <h3>제출이 완료되었습니다!</h3>
    <button id="successConfirm">확인</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDrkWBu5k-2nBHhZEHwgrBrPkWSKpro6po",
  authDomain: "sign-system-a8921.firebaseapp.com",
  projectId: "sign-system-a8921",
  storageBucket: "sign-system-a8921.appspot.com",
  messagingSenderId: "356422555230",
  appId: "1:356422555230:web:5522aefcfc133d096286cf"
};
initializeApp(firebaseConfig);
const db = getFirestore();

let data, pdfDoc, currentPage = 1, totalPages = 0;
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');
const marker = document.getElementById('marker');
const pageInfo = document.getElementById('pageInfo');
const sigModal = document.getElementById('sigModal');
const sigCanvas = document.getElementById('sigCanvas');
const sigCtx = sigCanvas.getContext('2d');
let tokenGlobal;
let signerName = "";

async function init() {
  const id = new URLSearchParams(location.search).get('id');
  const snap = await getDoc(doc(db, 'signRequests', id));
  if (!snap.exists()) return alert('잘못된 링크입니다.');
  data = snap.data();
  const rawPdf = Uint8Array.from(atob(data.pdfBase64), c => c.charCodeAt(0));
  pdfDoc = await pdfjsLib.getDocument({ data: rawPdf }).promise;
  totalPages = pdfDoc.numPages;
  renderPage(currentPage);
}

async function renderPage(n) {
  const page = await pdfDoc.getPage(n);
  const vp = page.getViewport({ scale: 1.5 });
  canvas.width = vp.width;
  canvas.height = vp.height;
  await page.render({ canvasContext: ctx, viewport: vp }).promise;
  pageInfo.textContent = `${n} / ${totalPages}`;
  if (n === data.page) {
    const mx = (data.posX / vp.width) * canvas.width;
    let my = (data.posY / vp.height) * canvas.height;
    if (!isNaN(my)) my += my * 0.08;
    marker.style.left = `${mx - marker.offsetWidth/2}px`;
    marker.style.top = `${my - marker.offsetHeight/2}px`;
    marker.style.display = 'block';
  } else {
    marker.style.display = 'none';
  }
}

document.getElementById('prevPage').onclick = () => { if (currentPage > 1) renderPage(--currentPage); };
document.getElementById('nextPage').onclick = () => { if (currentPage < totalPages) renderPage(++currentPage); };

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * (canvas.width / rect.width);
  const y = (e.clientY - rect.top) * (canvas.height / rect.height);
  const centerX = parseFloat(marker.style.left) + marker.offsetWidth/2;
  const centerY = parseFloat(marker.style.top) + marker.offsetHeight/2;
  if (currentPage === data.page && Math.hypot(x - centerX, y - centerY) < 50) {
    startAuth();
  }
});

document.getElementById('nameConfirm').onclick = () => {
  signerName = document.getElementById('nameInput').value.trim();
  if (!signerName) {
    alert('이름을 입력하세요!');
    return;
  }
  document.getElementById('nameModal').style.display = 'none';
  openModal();
};

function openModal() {
  sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
  sigModal.style.display = 'flex';
}

document.getElementById('clearSig').onclick = () => sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
document.getElementById('saveSig').onclick = async () => {
  sigModal.style.display = 'none';
  await sendEmail();
};

document.getElementById('successConfirm').onclick = () => {
  document.getElementById('successModal').style.display = 'none';
};

// 서명 캔버스 이벤트 연결 (중요)
let drawing = false;
['mousedown', 'touchstart'].forEach(evt =>
  sigCanvas.addEventListener(evt, e => {
    drawing = true;
    const pos = e.touches ? e.touches[0] : e;
    const rect = sigCanvas.getBoundingClientRect();
    sigCtx.beginPath();
    sigCtx.moveTo(pos.clientX - rect.left, pos.clientY - rect.top);
  })
);
['mousemove', 'touchmove'].forEach(evt =>
  sigCanvas.addEventListener(evt, e => {
    if (!drawing) return;
    const pos = e.touches ? e.touches[0] : e;
    const rect = sigCanvas.getBoundingClientRect();
    sigCtx.lineTo(pos.clientX - rect.left, pos.clientY - rect.top);
    sigCtx.stroke();
    e.preventDefault();
  })
);
['mouseup', 'touchend', 'mouseout'].forEach(evt =>
  sigCanvas.addEventListener(evt, () => drawing = false)
);

async function sendEmail() {
  const pngData = sigCanvas.toDataURL();
  const pngBase64 = pngData.split(',')[1];
  const rawPdf = Uint8Array.from(atob(data.pdfBase64), c => c.charCodeAt(0));
  const pdfLibDoc = await PDFLib.PDFDocument.load(rawPdf);
  const img = await pdfLibDoc.embedPng(pngData);
  const page = pdfLibDoc.getPage(data.page - 1);
  const dims = img.scale(0.2);
  const x = (data.posX ?? 0) - dims.width/2 - 75 - (data.posY ?? 0) * 0.02;
  const y = page.getHeight() - (data.posY ?? 0) - dims.height + (data.posY ?? 0) * 0.22 + (data.posY < 400 ? 10 : 0);
  page.drawImage(img, { x, y, width: dims.width, height: dims.height });

  const signedBytes = await pdfLibDoc.save();
  const signedBase64 = btoa(String.fromCharCode(...signedBytes));

  const subject = `[전자서명 제출] ${data.docTitle} - ${signerName}`;

  const boundary = 'BOUNDARY';
  const bodyText = `본인은 첨부된 "${data.docTitle}" 문서를 확인하였으며, 아래와 같이 서명합니다.\n\n- 제출자: ${signerName}\n- 제출 일시: ${new Date().toLocaleString()}`;
  const parts = [
    `--${boundary}`,
    'Content-Type: text/plain; charset=UTF-8', '', bodyText,
    `--${boundary}`,
    'Content-Type: application/pdf; name="document.pdf"',
    'Content-Disposition: attachment; filename="document.pdf"',
    'Content-Transfer-Encoding: base64', '', data.pdfBase64,
    `--${boundary}`,
    'Content-Type: image/png; name="signature.png"',
    'Content-Disposition: attachment; filename="signature.png"',
    'Content-Transfer-Encoding: base64', '', pngBase64,
    `--${boundary}`,
    'Content-Type: application/pdf; name="signed.pdf"',
    'Content-Disposition: attachment; filename="signed.pdf"',
    'Content-Transfer-Encoding: base64', '', signedBase64,
    `--${boundary}--`
  ];

  const emailBody = [
    'MIME-Version: 1.0',
    `To: ${data.receiver}`,
    `Subject: ${subject}`,
    `Content-Type: multipart/mixed; boundary=${boundary}`,
    '',
    ...parts
  ].join('\r\n');

const raw = btoa(emailBody).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/, '');

  gapi.load('client', () => {
    gapi.client.init({
      apiKey: 'AIzaSyBdO8g3lJHfxoiSqgOWXp1q37zMkrkaBg4',
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
    })
    .then(() => {
      gapi.client.setToken({ access_token: tokenGlobal });
      return gapi.client.gmail.users.messages.send({ userId: 'me', resource: { raw } });
    })
    .then(() => {
      document.getElementById('successModal').style.display = 'flex';
    })
    .catch(e => { console.error(e); alert('전송 실패'); });
  });
}

window.startAuth = () => google.accounts.oauth2.initTokenClient({
  client_id: '972595541590-k962h1slhqu6cm1r5fhp9nvdd8hu21vk.apps.googleusercontent.com',
  scope: 'https://www.googleapis.com/auth/gmail.send',
  callback: tok => {
    tokenGlobal = tok.access_token;
    document.getElementById('nameModal').style.display = 'flex';
  }
}).requestAccessToken();

init();
</script>

</body>
</html>
